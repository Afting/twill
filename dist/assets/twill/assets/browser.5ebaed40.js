import{a as c,_ as m,af as a,m as p,a0 as w,n as h,f,c as u}from"./form.af977733.js";var b=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"browser"},[s("div",{staticClass:"browser__frame"},[s("div",{ref:"form",staticClass:"browser__header"},[e.multiSources?s("div",{staticClass:"browser__sources"},[s("a17-vselect",{staticClass:"browser__sources-select",attrs:{name:"sources",selected:e.currentEndpoint,options:e.endpoints,required:!0},on:{change:e.changeBrowserSource}})],1):e._e(),s("div",{staticClass:"browser__search"},[s("a17-filter",{on:{submit:e.submitFilter}},[e.browserNote?s("div",{attrs:{slot:"additional-actions"},slot:"additional-actions"},[s("span",{staticClass:"browser__note f--small"},[e._v(" "+e._s(e.browserNote)+" ")])]):e._e()])],1)]),s("div",{staticClass:"browser__inner"},[s("div",{ref:"list",staticClass:"browser__list"},[s("a17-itemlist",{attrs:{items:e.fullItems,keysToCheck:["id","edit"],selectedItems:e.selectedItems},on:{change:e.updateSelectedItems}})],1)]),s("div",{staticClass:"browser__footer"},[s("a17-button",{attrs:{type:"button",variant:"action"},on:{click:e.saveAndClose}},[e._v(e._s(e.browserTitle))]),s("span",{staticClass:"browser__size-infos"},[e._v(e._s(e.selectedItems.length)+" / "+e._s(e.max))])],1)])])},g=[];const _={name:"A17Browser",components:{"a17-filter":c,"a17-itemlist":m},props:{btnLabel:{type:String,default:"Insert"},btnMultiLabel:{type:String,default:"Insert files"},initialPage:{type:Number,default:1}},data(){return{maxPage:20,fullItems:[],listHeight:0,page:this.initialPage}},computed:{currentEndpoint(){return this.endpoints.find(e=>e.value===this.endpoint)},multiSources(){return this.endpoints.length>0},selectedItems:{get(){return this.selected[this.connector]||[]},set(e){this.$store.commit(a.SAVE_ITEMS,e)}},...p({connector:e=>e.browser.connector,max:e=>e.browser.max,endpoint:e=>e.browser.endpoint,endpointName:e=>e.browser.endpointName,endpoints:e=>e.browser.endpoints,browserTitle:e=>e.browser.title,browserNote:e=>e.browser.note,selected:e=>e.browser.selected})},methods:{updateSelectedItems(e){const t=this.multiSources?["id","endpointType"]:["id"];if(!this.fullItems.some(i=>t.every(o=>i[o]===e[o])))return;if(this.selectedItems.some(i=>t.every(o=>i[o]===e[o]))){const i=this.selectedItems.findIndex(d=>t.every(r=>d[r]===e[r]));if(i<0)return;const o=[...this.selectedItems];o.splice(i,1),this.selectedItems=o}else{if(this.max===1&&this.clearSelectedItems(),this.selectedItems.length>=this.max&&this.max>0)return;this.selectedItems=[...this.selectedItems,e]}},getFormData(e){let t=w(e);return t?t.page=this.page:t={page:this.page},t},clearSelectedItems(){this.selectedItems=[]},clearFullItems(){this.fullItems.splice(0)},reloadList(e=!1){e&&(this.page=1);const t=this.$refs.form,s=this.$refs.list,n=this.getFormData(t);this.$http.get(this.endpoint,{params:n}).then(i=>{e&&this.clearFullItems(),this.fullItems.push(...i.data.data),this.$nextTick(()=>{this.listHeight!==s.scrollHeight&&(this.listHeight=s.scrollHeight,s.addEventListener("scroll",this.scrollToPaginate))})},function(i){})},submitFilter(){this.page=1,this.clearFullItems(),this.reloadList()},scrollToPaginate(){const e=this.$refs.list;e.scrollTop+e.clientHeight>this.listHeight-10&&(e.removeEventListener("scroll",this.scrollToPaginate),this.maxPage>this.page&&(this.page=this.page+1,this.reloadList()))},saveAndClose(){this.$store.commit(a.SAVE_ITEMS,this.selectedItems),this.$parent.close()},changeBrowserSource(e){this.$store.commit(a.UPDATE_BROWSER_ENDPOINT,e),this.reloadList(!0)}},mounted(){this.reloadList()}},l={};var x=h(_,b,g,!1,I,"20ebb3ff",null,null);function I(e){for(let t in l)this[t]=l[t]}var O=function(){return x.exports}();const v={connector:null,title:"Attach related resources",note:"",endpoint:"",endpointName:"",endpoints:[],max:0,selected:window.TWILL.STORE.browser.selected||{}},y={selectedItemsByIds:e=>{const t=[];for(const s in e.selected)t[s]=e.selected[s].map(n=>`${n.endpointType}_${n.id}`);return t},browsersByBlockId:e=>t=>{const s=Object.keys(e.selected).filter(i=>i.startsWith(`blocks[${t}]`)),n={};return s.forEach(i=>n[i]=e.selected[i]),n}},E={[a.SAVE_ITEMS](e,t){if(e.connector)if(e.selected[e.connector]&&e.selected[e.connector].length)e.selected[e.connector]=t;else{const s={};s[e.connector]=t,e.selected=Object.assign({},e.selected,s)}},[a.DESTROY_ITEMS](e,t){e.selected[t.name]&&f.delete(e.selected,t.name)},[a.DESTROY_ITEM](e,t){e.selected[t.name]&&(e.selected[t.name].splice(t.index,1),e.selected[t.name].length===0&&f.delete(e.selected,t.name),e.connector=null)},[a.REORDER_ITEMS](e,t){const s={};s[t.name]=t.items,e.selected=Object.assign({},e.selected,s)},[a.UPDATE_BROWSER_MAX](e,t){e.max=Math.max(0,t)},[a.UPDATE_BROWSER_CONNECTOR](e,t){t&&t!==""&&(e.connector=t)},[a.UPDATE_BROWSER_TITLE](e,t){t&&t!==""&&(e.title=t)},[a.UPDATE_BROWSER_NOTE](e,t){e.note=t},[a.DESTROY_BROWSER_CONNECTOR](e){e.connector=null},[a.UPDATE_BROWSER_ENDPOINT](e,t){t&&t!==""&&(e.endpoint=t.value,e.endpointName=t.label||"")},[a.DESTROY_BROWSER_ENDPOINT](e){e.endpoint="",e.endpointName=""},[a.UPDATE_BROWSER_ENDPOINTS](e,t){!t&&!t.length>0||(e.endpoints=t,e.endpoint=t[0].value,e.endpointName=t[0].label)},[a.DESTROY_BROWSER_ENDPOINTS](e){e.endpoints=[]},[a.ADD_BROWSERS](e,{browsers:t}){e.selected=Object.assign({},e.selected,t)}},S={async[u.DUPLICATE_BLOCK]({commit:e,getters:t},{block:s,id:n}){const i={...t.browsersByBlockId(s.id)},o=Object.keys(i),d={};o.forEach(r=>d[r.replace(s.id,n)]=[...i[r]]),e(a.ADD_BROWSERS,{browsers:d})}};var T={state:v,getters:y,mutations:E,actions:S};export{O as a,T as b};
