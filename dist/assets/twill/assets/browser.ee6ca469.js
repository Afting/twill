import{a as c,_ as m,af as o,m as p,a0 as w,n as h,f as l,c as u}from"./form.3ed58db1.js";var b=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"browser"},[n("div",{staticClass:"browser__frame"},[n("div",{ref:"form",staticClass:"browser__header"},[t.multiSources?n("div",{staticClass:"browser__sources"},[n("a17-vselect",{staticClass:"browser__sources-select",attrs:{name:"sources",selected:t.currentEndpoint,options:t.endpoints,required:!0},on:{change:t.changeBrowserSource}})],1):t._e(),n("div",{staticClass:"browser__search"},[n("a17-filter",{on:{submit:t.submitFilter}},[t.browserNote?n("div",{attrs:{slot:"additional-actions"},slot:"additional-actions"},[n("span",{staticClass:"browser__note f--small"},[t._v(" "+t._s(t.browserNote)+" ")])]):t._e()])],1)]),n("div",{staticClass:"browser__inner"},[n("div",{ref:"list",staticClass:"browser__list"},[n("a17-itemlist",{attrs:{items:t.fullItems,keysToCheck:["id","edit"],selectedItems:t.selectedItems},on:{change:t.updateSelectedItems}})],1)]),n("div",{staticClass:"browser__footer"},[n("a17-button",{attrs:{type:"button",variant:"action"},on:{click:t.saveAndClose}},[t._v(t._s(t.browserTitle))]),n("span",{staticClass:"browser__size-infos"},[t._v(t._s(t.selectedItems.length)+" / "+t._s(t.max))])],1)])])},_=[];const g={name:"A17Browser",components:{"a17-filter":c,"a17-itemlist":m},props:{btnLabel:{type:String,default:"Insert"},btnMultiLabel:{type:String,default:"Insert files"},initialPage:{type:Number,default:1}},data(){return{maxPage:20,fullItems:[],listHeight:0,page:this.initialPage}},computed:{currentEndpoint(){return this.endpoints.find(t=>t.value===this.endpoint)},multiSources(){return this.endpoints.length>0},selectedItems:{get(){return this.selected[this.connector]||[]},set(t){this.$store.commit(o.SAVE_ITEMS,t)}},...p({connector:t=>t.browser.connector,max:t=>t.browser.max,endpoint:t=>t.browser.endpoint,endpointName:t=>t.browser.endpointName,endpoints:t=>t.browser.endpoints,browserTitle:t=>t.browser.title,browserNote:t=>t.browser.note,selected:t=>t.browser.selected})},methods:{updateSelectedItems(t){const e=this.multiSources?["id","endpointType"]:["id"];if(!this.fullItems.some(i=>e.every(a=>i[a]===t[a])))return;if(this.selectedItems.some(i=>e.every(a=>i[a]===t[a]))){const i=this.selectedItems.findIndex(f=>e.every(r=>f[r]===t[r]));if(i<0)return;const a=[...this.selectedItems];a.splice(i,1),this.selectedItems=a}else{if(this.max===1&&this.clearSelectedItems(),this.selectedItems.length>=this.max&&this.max>0)return;this.selectedItems=[...this.selectedItems,t]}},getFormData(t){let e=w(t);return e?e.page=this.page:e={page:this.page},e},clearSelectedItems(){this.selectedItems=[]},clearFullItems(){this.fullItems.splice(0)},reloadList(t=!1){t&&(this.page=1);const e=this.$refs.form,n=this.$refs.list,s=this.getFormData(e);this.$http.get(this.endpoint,{params:s}).then(i=>{t&&this.clearFullItems(),this.fullItems.push(...i.data.data),this.$nextTick(()=>{this.listHeight!==n.scrollHeight&&(this.listHeight=n.scrollHeight,n.addEventListener("scroll",this.scrollToPaginate))})},function(i){})},submitFilter(){this.page=1,this.clearFullItems(),this.reloadList()},scrollToPaginate(){const t=this.$refs.list;t.scrollTop+t.clientHeight>this.listHeight-10&&(t.removeEventListener("scroll",this.scrollToPaginate),this.maxPage>this.page&&(this.page=this.page+1,this.reloadList()))},saveAndClose(){this.$store.commit(o.SAVE_ITEMS,this.selectedItems),this.$parent.close()},changeBrowserSource(t){this.$store.commit(o.UPDATE_BROWSER_ENDPOINT,t),this.reloadList(!0)}},mounted(){this.reloadList()}},d={};var x=h(g,b,_,!1,I,"20ebb3ff",null,null);function I(t){for(let e in d)this[e]=d[e]}var O=function(){return x.exports}();const v={connector:null,title:"Attach related resources",note:"",endpoint:"",endpointName:"",endpoints:[],max:0,selected:window[{}.VUE_APP_NAME].STORE.browser.selected||{}},y={selectedItemsByIds:t=>{const e=[];for(const n in t.selected)e[n]=t.selected[n].map(s=>`${s.endpointType}_${s.id}`);return e},browsersByBlockId:t=>e=>{const n=Object.keys(t.selected).filter(i=>i.startsWith(`blocks[${e}]`)),s={};return n.forEach(i=>s[i]=t.selected[i]),s}},E={[o.SAVE_ITEMS](t,e){if(t.connector)if(t.selected[t.connector]&&t.selected[t.connector].length)t.selected[t.connector]=e;else{const n={};n[t.connector]=e,t.selected=Object.assign({},t.selected,n)}},[o.DESTROY_ITEMS](t,e){t.selected[e.name]&&l.delete(t.selected,e.name)},[o.DESTROY_ITEM](t,e){t.selected[e.name]&&(t.selected[e.name].splice(e.index,1),t.selected[e.name].length===0&&l.delete(t.selected,e.name),t.connector=null)},[o.REORDER_ITEMS](t,e){const n={};n[e.name]=e.items,t.selected=Object.assign({},t.selected,n)},[o.UPDATE_BROWSER_MAX](t,e){t.max=Math.max(0,e)},[o.UPDATE_BROWSER_CONNECTOR](t,e){e&&e!==""&&(t.connector=e)},[o.UPDATE_BROWSER_TITLE](t,e){e&&e!==""&&(t.title=e)},[o.UPDATE_BROWSER_NOTE](t,e){t.note=e},[o.DESTROY_BROWSER_CONNECTOR](t){t.connector=null},[o.UPDATE_BROWSER_ENDPOINT](t,e){e&&e!==""&&(t.endpoint=e.value,t.endpointName=e.label||"")},[o.DESTROY_BROWSER_ENDPOINT](t){t.endpoint="",t.endpointName=""},[o.UPDATE_BROWSER_ENDPOINTS](t,e){!e&&!e.length>0||(t.endpoints=e,t.endpoint=e[0].value,t.endpointName=e[0].label)},[o.DESTROY_BROWSER_ENDPOINTS](t){t.endpoints=[]},[o.ADD_BROWSERS](t,{browsers:e}){t.selected=Object.assign({},t.selected,e)}},S={async[u.DUPLICATE_BLOCK]({commit:t,getters:e},{block:n,id:s}){const i={...e.browsersByBlockId(n.id)},a=Object.keys(i),f={};a.forEach(r=>f[r.replace(n.id,s)]=[...i[r]]),t(o.ADD_BROWSERS,{browsers:f})}};var T={state:v,getters:y,mutations:E,actions:S};export{O as a,T as b};
